function ErrorHandler(n){if(n!==undefined)["MISSING_AUTH_TOKEN","INVALID_SESSION"].includes(n.error)&&(document.location.href="/Users/Login")}function incrementValue(n){n.preventDefault();var t=$(n.target).data("field"),i=$(n.target).closest("div"),r=parseInt(i.find("input[name="+t+"]").val(),10);isNaN(r)?i.find("input[name="+t+"]").val(0):i.find("input[name="+t+"]").val(r+1)}function decrementValue(n){n.preventDefault();var t=$(n.target).data("field"),i=$(n.target).closest("div"),r=parseInt(i.find("input[name="+t+"]").val(),10);!isNaN(r)&&r>0?i.find("input[name="+t+"]").val(r-1):i.find("input[name="+t+"]").val(0)}var svc_prefix="/api/",noSleep=new NoSleep,MarketVM;Vue.component("runner-aggregate",{props:["name","back","lay","marketid"],template:`
        <div class="runner-runner">
            <h3 class="runner-name">
                <div class="runner-info">
                    <span class="clippable runner-display-name">
                        <h4 class="clippable-spacer">{{ name }}</h4>
                    </span>
                </div>
            </h3>
            <a class="price-price price-back">
                <span class="price-odd"></span>
                <span class="price-amount"></span>
            </a>
            <a class="price-price price-back">
                <span class="price-odd"></span>
                <span class="price-amount"></span>
            </a>
            <a class="price-price price-back mb-show" id="agg-back" v-on:click="$emit('betslip', 'B')">
                <span class="price-odd">{{ back }}</span>
            </a>
            <a class="price-price price-lay ml-4 mb-show" id="agg-lay" v-on:click="$emit('betslip', 'L')">
                <span class="price-odd">{{ lay }}</span>
            </a>
            <a class="price-price price-lay">
                <span class="price-odd"></span>
                <span class="price-amount"></span>
            </a>
            <a class="price-price price-lay mr-4">
                <span class="price-odd"></span>
                <span class="price-amount"></span>
            </a>
        </div>
    `});$("#MarketView").length>0&&(MarketVM=new Vue({el:"#MarketView",data:{IsLoaded:!1,runnerUnavailable:["suspended","ball running","removed"],Catalog:{marketName:"Loading...",runners:[]},LoadingSubMarkets:!1,MarketPL:[],subMarketIds:[],subMarkets:[],aggregateRun:{marketId:"",runnerName:"",selectionId:0,back:"",lay:""},IsAggregateOrder:!1,BookIntervalId:"",OrderIntervalId:"",score:{team1:null,commentry:null},scoreLines:[],IsVoice:!1,SelectMarketName:"",SelectFancyPos:[],Order:{render:!1,working:!1,price:1.01,size:0,side:"B",selectionId:0,isLine:!1},OrderPrice:"1.01",OldPrice:"1.01",Matched:[],UnMatched:[],displayOn:!1,backColor:"227,248,255",layColor:"255,205,204",plusFlash:"0,178,255",minusFlash:"255,122,127",IsPageVisible:!0,fromNow:"starting soon",fancySize:0},created:function(){document.getElementById("loadedmarkettoshow").classList.remove("d-none");marketId!==undefined&&marketId!==""&&(this.FetchCatalog(marketId),this.aggregateRun.runnerName="",this.aggregateRun.marketId=marketId);var n;typeof document.hidden!="undefined"?(hidden="hidden",n="visibilitychange"):typeof document.msHidden!="undefined"?(hidden="msHidden",n="msvisibilitychange"):typeof document.webkitHidden!="undefined"&&(hidden="webkitHidden",n="webkitvisibilitychange");document.addEventListener(n,this.handleVisibilityChange,!1)},computed:{sport_icon:function(){return"/img/v2/"+this.Catalog.sport.image},prettyDate:function(){return this.Catalog.marketStartTime===""?"":moment(this.Catalog.marketStartTime).format("MMM D h:mm a")},CurrentMarketIdsHash:function(){var n=_.map(this.subMarkets,function(n){return n.marketId});return n=_.sortBy(n,function(n){return n}),n.join(",")},HasFancyChild:function(){var n=_.find(this.subMarkets,function(n){return n.bettingType==="LINE"&&n.marketType!=="LOCAL_FANCY"});return n!==undefined},HasNonFancyChild:function(){var n=_.find(this.subMarkets,function(n){return n.bettingType!=="LINE"});return n!==undefined},HasLocalFancy:function(){var n=_.find(this.subMarkets,function(n){return n.marketType==="LOCAL_FANCY"});return n!==undefined},RunnersAggregate:function(){return _.filter(this.Catalog.runners,function(n){return n.selected})},IsFixedOdds:function(){return this.Order.selectionId===0||this.Order.isLine||this.IsLocalOdds},IsLocalOdds:function(){return this.Catalog.origin=="BETPRO"&&!this.Catalog.isFancy}},watch:{score:function(n,t){n!==null&&n.commentry!==null&&t.commentry!==n.commentry&&this.PlayCommentry(n.commentry)},displayOn:function(){}},methods:{handleVisibilityChange:function(){this.IsPageVisible=document[hidden]?!1:!0},IsRunnerDisabled:function(n){return n===undefined||n===""||n===null?!1:this.runnerUnavailable.includes(n.toLowerCase())},FetchCatalog:function(n){var t=this,i=svc_prefix+"markets/catalog2/?id="+n;$.getJSON(i,function(n){n.totalMatched=0;t.Catalog=n;_.each(t.Catalog.runners,function(n){n.ticks=0;n.selected=!1});t.IsLoaded=!0;setTimeout(function(){$('[data-toggle="tooltip"]').tooltip()},500);t.ListMarketData();t.BookIntervalId=setInterval(t.ListMarketData,1e3);t.OrderIntervalId=setInterval(t.ListOrders,1500)})},ListMarketData:function(){var n,t,i;this.IsPageVisible&&(n=svc_prefix+"Markets/Data",this.Catalog!==null&&this.Catalog.hasOwnProperty("marketId")&&(t={RequestId:"1",MarketIds:[this.Catalog.marketId],IncludeProfitLoss:!0},i=this,$.ajax({type:"POST",url:n,data:JSON.stringify(t),contentType:"application/json; charset=utf-8",dataType:"json",success:function(n){i.RenderMarketData(n)},error:function(n){ErrorHandler(n.responseJSON)}})))},ClearTimers:function(){clearInterval(this.BookIntervalId);clearInterval(this.OrderIntervalId)},RenderMarketData:function(n){var t,r,i,u;if(n!==null&&n.marketBooks.length!==0)if(this.fromNow=moment(this.Catalog.marketStartTime).fromNow(),t=n.marketBooks[0],this.Catalog.totalMatched=t.totalMatched,this.Catalog.status=t.marketStatus,this.Catalog.betDelay=t.betDelay,this.score=n.scoreboard,this.scoreLines=n.fancy,this.MarketPL=n.profitLoss,this.Catalog.news=n.news,this.fancySize=n.betSizes.fancy,this.Catalog.eventTypeId==4&&this.Catalog.isFancy===!1&&(this.Catalog.maxBetSize=n.betSizes.cricket),this.Catalog.eventTypeId==4&&this.Catalog.isFancy&&(this.Catalog.maxBetSize=n.betSizes.fancy),this.Catalog.eventTypeId==1&&(this.Catalog.maxBetSize=n.betSizes.soccer),this.Catalog.eventTypeId==2&&(this.Catalog.maxBetSize=n.betSizes.tennis),this.Catalog.eventTypeId==7&&(this.Catalog.maxBetSize=n.betSizes.race),this.Catalog.eventTypeId==4339&&(this.Catalog.maxBetSize=n.betSizes.greyhound),t.marketStatus==="CLOSED"&&this.ClearTimers(),r=this,this.Catalog.runners.forEach(function(i){var u=t.runners.find(function(n){return n.id===i.selectionId.toString()}),f;n.profitLoss!==null&&(f=n.profitLoss.find(function(n){return n.selectionID===i.selectionId&&n.marketId===t.id}));u!==undefined&&(u.status==="WINNER"&&r.MarkWinner(u.id),r.UpdateRunnersPriceSize(i,u),f!==undefined?(i.ifWin=f.ifWin,i.ifLose=f.ifLose):(i.ifWin=null,i.ifLose=null))}),this.RunnersAggregate.length>0&&this.UpdateAggregateOdds(t),n.marketBooks.length>0){if(i=_.map(n.marketBooks,function(n){return n.id}),i=_.without(i,this.Catalog.marketId),i.length===0)return;if(i=_.sortBy(i,function(n){return n}),u=i.join(","),u===r.CurrentMarketIdsHash){_.each(n.marketBooks,this.RenderSubMarketData);return}if(r.LoadingSubMarkets)return;r.LoadingSubMarkets=!0;this.subMarkets=[];this.subMarketIds=[];this.FetchCatalogs(i)}else this.subMarkets=[],this.subMarketIds=[]},UpdateAggregateOdds:function(n){var f=this,r=[],u=[],t,i;_.map(n.runners,function(n){var t=f.RunnersAggregate.filter(function(t){return t.selectionId.toString()===n.id});_.each(t,function(n){r.push(parseFloat(n.price1)-1);u.push(parseFloat(n.lay1)-1)})});t="";u.includes(NaN)||(t=this.AggregateOdds(u));i="";r.includes(NaN)||(i=this.AggregateOdds(r));i!==this.aggregateRun.back&&(this.aggregateRun.back=i,$("#agg-back").flash("#8dd2f0",this.plusFlash,300));t!==this.aggregateRun.lay&&(this.aggregateRun.lay=t,$("#agg-lay").flash("#feafb2",this.minusFlash,300));this.Order.hasOwnProperty("price")&&this.IsAggregateOrder&&(this.Order.price=this.Order.side==="B"?i:t,this.CalcPL())},AggregateOdds:function(n){var t=n[0];if(n.length===1)t=n[0];else for(i=1;i<n.length;i++)n[i]===""||n[i]<0||(t=(t*n[i]-1)/(t+n[i]+2));return t<=0?0:Math.round(t*100)/100},UpdateRunnersPriceSize:function(n,t){return n.price1=this.IndicatePriceChange(n,n.price1,t.price1,"indB1","#8dd2f0"),n.size1=this.IndicateSizeChange(n,n.size1,t.size1,"indB1","#8dd2f0"),n.lay1=this.IndicatePriceChange(n,n.lay1,t.lay1,"indL1","#feafb2"),n.ls1=this.IndicateSizeChange(n,n.ls1,t.ls1,"indL1","#feafb2"),n.price2=t.price2,n.size2=t.size2,n.price3=t.price3,n.size3=t.size3,n.lay2=t.lay2,n.lay3=t.lay3,n.ls2=t.ls2,n.ls3=t.ls3,n.status=t.status,n},IndicatePriceChange:function(n,t,i,r,u){if(++n.ticks,t===i)return n.ticks>=7&&(n.ticks=0,n[r]=""),i;n.ticks=0;t>i&&(n[r]="d",n.IsDown=!0);i>t&&(n[r]="u",n.IsUp=!0);bg=this.plusFlash;var f=r.replace("ind",""),e="#"+f+"-"+n.selectionId;return bg=f.includes("B")?this.plusFlash:this.minusFlash,$(e).flash(u,bg,300),i},IndicateSizeChange:function(n,t,i,r,u){if(t===i)return i;bg=this.plusFlash;var f=r.replace("ind",""),e="#"+f+"-"+n.selectionId;return bg=f.includes("B")?this.plusFlash:this.minusFlash,$(e).flash(u,bg,300),i},MarkWinner:function(n){$("#runner-"+n).addClass("winner")},UpdatePriceCell:function(n,t,i,r,u){if(n===t)return t;bg=n>t?this.plusFlash:this.minusFlash;var f="#"+i+"-"+r;return $.flash!==undefined&&$(f).flash(u,bg,300),t},FetchCatalogs:function(n){var t=n.join(","),i=svc_prefix+"markets/catalogs/?ids="+t;$.getJSON(i,this.RenderSubMarkets)},RenderSubMarkets:function(n){var t=this;n!==null&&n.length>0&&(n=_.sortBy(n,"marketName"),_.each(n,function(n){n.status2=null;t.subMarkets.push(n)}));this.LoadingSubMarkets=!1},RemoveCatalogues:function(n){if(n.length!==0){var t=this;_.each(n,function(n){_.filter(t.subMarkets,function(t){return n!==t.marketId})})}},RenderSubMarketData:function(n){if(!this.LoadingSubMarkets&&(market=_.find(this.subMarkets,function(t){return t.marketId===n.id}),market!==undefined)){market.status2=n.status2;var t=this;market.runners.forEach(function(i){var u=n.runners.find(function(n){return n.id===i.selectionId.toString()}),r=t.MarketPL.find(function(t){return t.selectionID===i.selectionId&&t.marketId===n.id});u!==undefined&&(t.UpdateRunnersPriceSize(i,u),r!==undefined?(i.ifWin=r.ifWin,i.ifLose=r.ifLose):(i.ifWin=null,i.ifLose=null))})}},ShowBetSlip:function(n,t,i,r){this.Order.render=!1;this.Order.size="";this.IsAggregateOrder=!1;this.Order.size===0&&(this.Order.size=this.GetDefaultStake());this.Order.isLine=this.IsLineMarket(i);var u=0,f=null;switch(r){case 1:t.toLowerCase()==="b"?(u=n.price1,f=n.size1):(u=n.lay1,f=n.ls1);break;case 2:t.toLowerCase()==="b"?(u=n.price2,f=n.size2):(u=n.lay2,f=n.ls2);break;case 3:t.toLowerCase()==="b"?(u=n.price3,f=n.size3):(u=n.lay3,f=n.ls3)}u!==undefined&&u!==null&&(u=parseFloat(u),f=parseFloat(f),this.OrderPrice=u,this.Order.price=u,this.Order.fancyPrice=f,this.Order.runnerName=n.runnerName,this.Order.selectionId=n.selectionId,this.Order.marketId=i,this.Order.side=t.toUpperCase(),this.Order.persist=!0,this.Order.identity=GetDeviceIdentity(),this.CalcPL(),t==="L"?($("#Place-Order,#PrInc,#PrDec").removeClass("btn-info"),$("#Place-Order,#PrInc,#PrDec").addClass("btn-danger"),$("#bet-slip-head").removeClass("bg-primary"),$("#bet-slip-head").addClass("bg-danger")):($("#Place-Order,#PrInc,#PrDec").addClass("btn-info"),$("#Place-Order,#PrInc,#PrDec").removeClass("btn-danger"),$("#bet-slip-head").removeClass("bg-danger"),$("#bet-slip-head").addClass("bg-primary")),IsMobile()?this.ShowBetSlipMobile():(this.Order.render=!0,setTimeout(function(){$("#betSlip")[0].scrollIntoView();$("#bet-size").focus()},150)))},ShowBetSlipMobile:function(){$("#betSlipMobile").modal("show")},HideBetSlip:function(){$("#betSlipMobile").modal("hide")},IsLineMarket:function(n){if(isLine=!1,this.Catalog.marketId===n)isLine=this.Catalog.bettingType==="LINE";else{var t=_.find(this.subMarkets,function(t){return t.marketId===n});isLine=t===undefined?!1:t.bettingType==="LINE"}return isLine},GetDefaultStake:function(){var n=$(".btn-stake")[0];return n?$(n).data("amount"):1e3},CloseBetSlip:function(){this.Order.render=!1},ClearBetSlip:function(){this.Order.size="";document.getElementById("bet-size").focus()},CalcPL:function(){if(price=parseFloat(this.Order.price),size=parseFloat(this.Order.size),this.IsLineMarket(this.Order.marketId))profit=size,liable=size;else{var n=this.IsAggregateOrder?price:price-1;this.Order.side==="B"?(profit=n*size,liable=size):(profit=size,liable=n*size)}this.Order.profit=numeral(profit).format("0,0[.]00");this.Order.liable=numeral(liable).format("0,0[.]00")},SetOrderSize:function(n){this.Order.size=n;this.CalcPL()},IncreaseOrderSize:function(n){this.Order.size===""&&(this.Order.size=0);this.Order.size+=n;this.CalcPL()},PlaceOrder:function(){var t,n,i;this.Order.working||(this.Order.working=!0,this.Order.error="",t=[],this.Order.selectionId===0?t=this.AggregateOrdersList():(val=parseFloat(this.Order.price),this.UpdatePrice(val),this.Order.size=parseFloat(this.Order.size),t.push(this.Order)),n=this,i=svc_prefix+"Orders",$.ajax({type:"POST",url:i,data:JSON.stringify(t),contentType:"application/json; charset=utf-8",dataType:"json",success:function(){console.log("Placed: "+moment().format("mm:ss"));n.Order.working=!1;n.Order.render=!1;n.HideBetSlip();n.Order.error="";$("#place-error").hide();n.Order.size=n.GetDefaultStake();GetFunds()},error:function(t){n.Order.working=!1;n.Order.error=t.responseJSON.error}}))},ListOrders:function(){if(this.IsPageVisible&&marketId!==null){var n=this,t=svc_prefix+"orders?MaxResults=0&MarketId="+marketId;$.getJSON(t,function(t){return n.RenderOrders(n,t),!1}).fail(function(n){ErrorHandler(n.responseJSON)})}},RenderOrders:function(n,t){var r=t.filter(function(n){return n.ms>0}),u=r.length!==n.Matched.length,i;u&&(console.log("New Order: "+moment().format("mm:ss")),n.Matched=[],r.forEach(function(t){t.IsBack=t.bs==="B";t.IsLay=t.bs==="L";n.Matched.push(t)}));i=t.filter(function(n){return n.us-n.ms>0});i.forEach(function(t){t.IsBack=t.bs==="B";t.IsLay=t.bs==="L";var i=n.UnMatched.findIndex(function(n){return n.id===t.id});i===-1?(console.log("New Order: "+moment().format("mm:ss")),n.UnMatched.unshift(t)):n.UnMatched[i]=t});n.UnMatched.forEach(function(t,r){var u=i.findIndex(function(n){return t.id===n.id});u===-1&&n.UnMatched.splice(r,1)})},Cancel:function(n){var i=this,t=svc_prefix+"orders/"+n.id;$.ajax({type:"DELETE",url:t,contentType:"application/json; charset=utf-8",dataType:"json",success:function(){GetFunds()},error:function(n){ErrorHandler(n.responseJSON)}})},ShowFancyPosition:function(n){this.FetchLinePosition(n);var t=_.find(this.subMarkets,function(t){return t.marketId===n});t!==undefined&&(this.SelectMarketName=t.marketName)},FetchLinePosition:function(n){var t=this;$.get(svc_prefix+"orders/LinePosition/?marketId="+n,function(n){t.SelectFancyPos=n;$("#fancyPosition").modal("show")})},PriceUp:function(){if(!this.IsFixedOdds){var n=parseFloat(this.Order.price),t=this.OneStepIncrement(n);this.UpdatePrice(t)}},PriceDown:function(){if(!this.IsFixedOdds){var n=parseFloat(this.Order.price),t=this.OneStepDecrement(n);this.UpdatePrice(t)}},OneStepIncrement:function(n){return n===""||n===undefined?undefined:(this.IsLineMarket(this.Order.marketId)?n=Math.round(n):(validInc=PriceValidator.GetValidIncrement(n),n=n+validInc),n)},OneStepDecrement:function(n){return n===""||n===undefined?undefined:(this.IsLineMarket(this.Order.marketId)?n=Math.round(n):(validDec=PriceValidator.GetValidDecrement(n),n=n-validDec),n)},UpdatePrice:function(n){this.IsLocalOdds?n=n:PriceValidator.IsLine||n>=20?n=Math.round(n):(n=parseFloat(PriceValidator.ValidatePrice(n)),n=n.toFixed(2));this.OrderPrice=n;this.Order.price=parseFloat(n);this.OldPrice=n;this.CalcPL()},PlayCommentry:function(n){this.IsVoice&&CommentryPlayer.Play(n)},ShowRules:function(n,t){var i,r;t==="Fancy"&&this.subMarkets.length>0&&(n=this.subMarkets[0].marketId);i="";this.Catalog.marketId===n?i=this.Catalog.rules:(r=_.find(this.subMarkets,function(t){return t.marketId===n}),r!==undefined&&(i=r.rules));$("#rules-box").html(i);$("#modalRules").modal("show")},toggleRunner:function(n){this.RunnersAggregate.length>=7&&!n.selected||(n.selected=!n.selected,this.Catalog.runners.push([]),this.Catalog.runners.pop(),aggRunnerName=[],_.each(this.RunnersAggregate,function(n){var t=n.runnerName.split(".");t.length>1&&aggRunnerName.push(t[0])}),this.aggregateRun.runnerName=aggRunnerName.join(" + "))},ShowBetSlipForAggregate:function(n){(n.toLowerCase()!=="b"||this.aggregateRun.back!=="")&&(n.toLowerCase()!=="l"||this.aggregateRun.lay!=="")&&(this.aggregateRun.price1=this.aggregateRun.back,this.aggregateRun.lay1=this.aggregateRun.lay,this.ShowBetSlip(this.aggregateRun,n,this.aggregateRun.marketId,1),this.IsAggregateOrder=!0)},AggregateOrdersList:function(){var n;return TotalPercentage=0,iTemPercentage=0,side=this.Order.side,n=this,TotalPercentage=_.reduce(this.RunnersAggregate,function(n,t){var i=side.toLowerCase()==="b"?t.price1:t.lay1;return n+100/i},TotalPercentage),_.map(this.RunnersAggregate,function(t){var r=side.toLowerCase()==="b"?t.price1:t.lay1,i;return iTemPercentage=100/r,i={price:r,runnerName:t.runnerName,selectionId:t.selectionId,marketId:n.Order.marketId,side:side.toUpperCase(),persist:!0,size:Math.round(iTemPercentage/TotalPercentage*n.Order.size)},i.identity=GetDeviceIdentity(),i})},MetadataHtml:function(n){return"Jockey: <b>"+n.jockeyName+"<\/b><br>Trainer: <b>"+n.trainerName+"<\/b><br>Age / Weigth: <b>"+n.age+"/"+n.weight+"<\/b><br>Days since last run: <b>"+n.lastRun+"<\/b><br>Wearing: <b>"+n.wearing+"<\/b>"},MetadataHtml2:function(n){return"<table class='table table-sm'><tr><td>Jockey<\/td><th>"+n.jockeyName+"<\/th><\/tr><tr><td>Trainer<\/td><th>"+n.trainerName+"<\/th><\/tr><tr><td>Age / Weigth<\/td><th>"+n.age+"/"+n.weight+"<\/th><\/tr><\/table>"}}}));$(".input-group").on("click",".button-plus",function(n){incrementValue(n)});$(".input-group").on("click",".button-minus",function(n){decrementValue(n)});$(".burger-toggle").on("click",function(){$("body").toggleClass("menu-collapsed");$(this).toggleClass("active")});$(document).ready(function(){jQuery.fn.flash=function(n,t,i){var r=this.css("backgroundColor");this.css("backgroundColor","rgb("+t+")").animate({backgroundColor:"rgb("+n+")"},i)};$(window).on("unload",function(){MarketVM!==undefined&&MarketVM.ClearTimers()});$("#IsDisplayOn").click(function(){$(this).attr("disabled",!0);noSleep.enable()})});